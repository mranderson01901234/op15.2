# Current Work Context

## Active View
- **Primary**: Desktop view (default development)
- **Secondary**: Mobile view (when `activeMobilePanel === "chat"`)

## Current Focus Area
**Chat Input Focus Behavior**
- Issue: Textarea not auto-focusing when clicking "New Chat" button
- Root Cause: Two separate textarea components (desktop/mobile) sharing same ref
- Location: `app/page.tsx` lines ~4654 (desktop) and ~5302 (mobile)

## Known Issues

### Critical
1. **Focus Not Working on New Chat**
   - Desktop textarea at line 4654
   - Mobile textarea at line 5302
   - Both use `textareaCallbackRef` but only one is rendered at a time
   - Focus logic doesn't check which one is actually visible

2. **Duplicate Textarea Components**
   - Desktop: Always rendered
   - Mobile: Only when `activeMobilePanel === "chat"`
   - Should be single responsive component

3. **Scattered Focus Logic**
   - 33 references to `forceFocusTextarea`
   - Focus logic in 5+ different useEffect hooks
   - Competing handlers causing conflicts

### Architecture
- `app/page.tsx` is 5400+ lines (too large)
- Mobile/desktop conditional rendering causing ref conflicts
- Focus trap running every 100ms (performance concern)

## Component Status

| Component | Status | Mobile Tested | Desktop Tested | Notes |
|-----------|--------|--------------|----------------|-------|
| Chat Input (Desktop) | ‚ö†Ô∏è Needs Fix | N/A | ‚úÖ | Focus not working |
| Chat Input (Mobile) | ‚ö†Ô∏è Needs Fix | ‚ùå | N/A | Focus not working |
| Focus Logic | üöß Scattered | N/A | N/A | Needs consolidation |

## Recent Changes

### 2024-01-XX - Focus Fix Attempts
- Added `forceFocusTextarea` function
- Added focus trap with interval
- Added new chat event listener
- **Result**: Still not working - ref conflicts

### Mobile View Addition
- Added `activeMobilePanel` conditional rendering
- Created separate mobile textarea
- **Impact**: Broke focus behavior due to ref sharing

## Next Steps

1. **Immediate**: Fix focus by checking which textarea is visible before focusing
2. **Short-term**: Extract focus logic to `hooks/use-chat-input-focus.ts`
3. **Medium-term**: Consolidate to single responsive textarea component
4. **Long-term**: Break down `app/page.tsx` into smaller components

## Testing Checklist

When testing focus fixes:
- [ ] Click "New Chat" button ‚Üí textarea should focus
- [ ] Reload page ‚Üí textarea should focus
- [ ] Switch chats ‚Üí textarea should focus
- [ ] Send message ‚Üí textarea should refocus
- [ ] Test on mobile viewport
- [ ] Test on desktop viewport

## File Locations

- Main chat page: `app/page.tsx`
- Chat context: `contexts/chat-context.tsx`
- Mobile hook: `hooks/use-mobile.ts`
- Workspace context: `contexts/workspace-context.tsx` (has `activeMobilePanel`)

## Key Dependencies

- `useIsMobile()` - Determines viewport size
- `activeMobilePanel` - Controls which mobile panel is shown
- `textareaRef` - Shared ref causing conflicts
- `textareaCallbackRef` - Callback ref for focus on mount

